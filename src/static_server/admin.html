<!doctype html>
<html lang="ru">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Togetherness Admin</title>
</head>

<style>
    #status {
        line-height: 1.6rem;
        padding: 0.25rem 0.5rem;
        border: none;
        border-radius: 0.25rem;
    }

    .alert-success {
        color: #155724;
        background-color: #d4edda;
    }

    .alert-error {
        color: #721c24;
        background-color: #f8d7da;
    }

    .alert-info {
        color: #0c5460;
        background-color: #d1ecf1;
    }
</style>

<script>
    function setRepeatedActions() {
        let checked = document.getElementById('repeated_actions').checked;
        submitValue('/api/admin/repeated_actions', checked);
        if (checked) {
            document.getElementById('repeated_actions_value').textContent = "Разрешены";
        } else {
            document.getElementById('repeated_actions_value').textContent = "Запрещены";
        }
    }
    function submitForm(url, valueId) {
        let value = document.getElementById(valueId).value;
        if (value == null || value == "") {
            setStatus("Пустое значение", "error");
            return;
        }
        setStatus("...");
        submitValue(url, value);
    }
    function submitValue(url, value) {
        fetch(url, {
            method: 'POST',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            body: value
        })
            .then((response) => response.json())
            .then(response => {
                if (response.error == "AlreadyStarted") {
                    setStatus("Сначала надо остановить таймер", "error");
                } else if (response.error == "NotStarted") {
                    setStatus("Сначала надо запустить таймер", "error");
                } else if (response.error == "SetToZero") {
                    setStatus("Сначала надо задать продолжительность ночи", "error");
                } else if (response.error == "MultiThread") {
                    setStatus("Внутренняя ошибка, ничего не получилось", "error");
                } else if (response.error == "None") {
                    setStatus("Ok", "success");
                } else {
                    setStatus(response.error, "error");
                }
            })
    }
    function setStatus(value, type) {
        let status = document.querySelector("#status");
        if (type == "success") {
            status.classList = "alert-success";
        } else if (type == "error") {
            status.classList = "alert-error";
        } else {
            status.classList = "alert-info";
        }
        status.textContent = value;
    }
</script>

<body>
    <h1>Праздник Единения: админка</h1>

    <p>
        <hr>
        Страница загружена: <a id="status" class="alert-info">{{status}}</a>.
        <hr>
    </p>

    <h2>Таймер: <i>{{timer}}</i> *</h2>
    <p>* Страница была загружена, когда до окончания Ночи оставалось столько. Чтобы увидеть текущее состояние таймера,
        обновите страницу.</p>

    <h2>Управление</h2>
    <form>
        <label for="duration">Продолжительность игры:</label>
        <input id="duration" type="number" step="1" min="1" max="240" placeholder="1–240" size="6" pattern="\d+" />
        минут.
        <input id="save" type="button" value="Установить" onclick="submitForm('/api/admin/duration', 'duration')">
    </form>
    <p>
        <input id="start" type="button" value="Старт" onclick="submitValue('/api/admin/start', null)">
        <input id="stop" type="button" value="Экстренный стоп" onclick="submitValue('/api/admin/stop', null)"> *
    </p>
    <p>* Игроки не смогут взаимодействовать до повторного нажатия кнопки «старт», состояние таймера будет сброшено.
        Профили игроков и история взаимодействий будут сохранены. Не забудьте сократить время игры, прежде чем снова
        нажимать «старт».</p>
    <p>Повторные взаимодействия с тем же игроком:
        <input id="repeated_actions" type="checkbox" {{repeated_actions.checked}} onclick="setRepeatedActions()">
        (сейчас <a id="repeated_actions_value">{{repeated_actions.string}}</a>).
    </p>

    <h2>Статистика</h2>
    <h3>Фракции</h3>
    <table>
        <thead>
            <tr>
                <th>Фракция</th>
                <th>Число членов</th>
                <th>Золото</th>
            </tr>
        </thead>
        <tbody>
            {% for faction in factions %}
            <tr>
                <td>{{faction.name}}</td>
                <td>{{faction.members}}</td>
                <td>{{faction.gold}}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <h3>Взаимодействия</h3>
    За прошедшее время игроки проделали друг с другом следующее:
    <ul>
        <li>Обняли: <i>{{stats.hug}}</i> раз</li>
        <li>Подслушали: <i>{{stats.eavesdropping}}</i> раз</li>
        <li>Шантажировали: <i>{{stats.blackmail}}</i> раз</li>
        <li>Пустили слухи: <i>{{stats.gossip}}</i> раз</li>
        <li>Совершили преступление: <i>{{stats.crime}}</i> раз</li>
    </ul>
</body>

</html>
